<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/cbn-copy-clipboard/cbn-copy-clipboard.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="ajp-category-data.html">
<link rel="import" href="ajp-common-styles.html">
<link rel="import" href="ajp-form-styles.html">

<dom-module id="ajp-detail">

	<template>

		<style include="ajp-common-styles ajp-form-styles">

			:host {
				display: block;
			}

			#content {
				@apply(--layout-horizontal);
				@apply(--layout-center-justified);
			}

			h1 {
				font-size: 27px;
				font-weight: 500;
				line-height: 28px;
				margin: 0;
			}

			.price {
				margin: 16px 0 40px;
				font-size: 19px;
				color: var(--app-secondary-color);
			}

			.detail-frame {
				margin: 64px auto;
			}

			.img-article {
				width: 100%;
				max-width: 500px;
				margin-top: 20px;
				margin-bottom: 20px;
			}

			.pickers {
				@apply(--layout-vertical);
				border-top: 1px solid #ccc;
			}

			ajp-select > select {
				font-size: 19px;
				padding: 16px 24px 16px 70px;
			}

			@media (max-width: 767px) {

				#content {
					@apply(--layout-vertical);
					@apply(--layout-center);
				}

				h1 {
					font-size: 23px;
					line-height: 24px;
				}

				.price {
					font-size: inherit;
					margin: 12px 0 32px;
				}

			}

		</style>

		<!--
			app-route provides the name of the category and the item.
		-->
		<app-route
				route="[[route]]"
				pattern="/:category/:item"
				data="{{routeData}}"></app-route>

		<!--
			ajp-category-data provides the item data for a given category and item name.
		-->
		<ajp-category-data
				id="categoryData"
				category-name="[[routeData.category]]"
				item-name="[[routeData.item]]"
				item="{{item}}"
				failure="{{failure}}"></ajp-category-data>

		<div class="main-frame detail-frame" hidden$="[[failure]]">

			<header class="header left">
				<h1>[[item.title]]</h1>
				<span>[[item.date]]</span>
			</header>

			<div class="content">
				<p id="desc"></p>
			</div>
		</div>

		<!--
			ajp-network-warning shows a warning message when the items can't be rendered due
			to network conditions.
		-->
		<ajp-network-warning
				hidden$="[[!failure]]"
				offline="[[offline]]"
				on-try-reconnect="_tryReconnect"></ajp-network-warning>

	</template>

	<script>

		Polymer({

			is: 'ajp-detail',

			properties: {

				item: Object,

				route: Object,

				routeData: Object,

				visible: Boolean,

				offline: {
					type: Boolean,
					observer: '_offlineChanged'
				},

				failure: Boolean

			},

			observers: [
				'_itemChanged(item, visible)'
			],

			_itemChanged: function(item, visible) {
				if (visible) {
					this.debounce('item-change', function() {
						// The item html contains escaped HTML (e.g. "&lt;br&gt;"), so we need to
						// unescape it ("<br>") and set it as innerHTML.
						var text = item ? item.html : '';
						this.$.desc.innerHTML = this._unescapeText(text);

						this.fire('change-section', {
							category: item.category,
							title: item.title
						});
					});
				}
			},

			_unescapeText: function(text) {
				var elem = document.createElement('textarea');
				elem.innerHTML = text;
				return elem.textContent;
			},

			_isDefined: function(item) {
				return item != null;
			},

			_tryReconnect: function() {
				this.$.categoryData.refresh();
			},

			_offlineChanged: function(offline) {
				if (!offline) {
					this._tryReconnect();
				}
			}

		});

	</script>

</dom-module>
